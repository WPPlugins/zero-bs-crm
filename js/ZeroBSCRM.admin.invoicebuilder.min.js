/*!
 * Zero BS CRM
 * http://www.epicplugins.com
 * V1.0
 *
 * Copyright 2016, Epic Plugins, StormGate Ltd.
 *
 * Date: 17/06/2016
 */

// this is a blocker... ctrl F it
var zbsInvBlocker = false;


// WH moved this from global JS 1.1.19
jQuery(document).ready(function(){

		// Just reference directly: zbsCurr = window.zbJS_curr;

		// hack for weird tax bug
		if(jQuery('#invoice_tax_total').val() > 0){
			jQuery('#invoice_totals .tax_total').show();
		}

		// invoice row actions
		zbscrm_JS_bindrowactions();

		//some other stuff... shizzle
		zbscrm_JS_changeactions();

		// who knows? 
		zbscrm_JS_mikesFloatingBinds();

});



function zbscrm_JS_bindrowactions(){
	jQuery('.zbs-add-row').unbind('click').bind('click',function(e){
		var zbsinvrownum = jQuery('.zbs-item-block').last().data('tableid');
		if(zbsinvrownum == 30){
			//max out at 30
			swal({title: "Error!",text: "30 rows is the maximum supported!",type: "error",confirmButtonText: "OK"});
			return false;
		}
		zbsinvrownum++;
		if(window.zbs_tax){
		rowhtml = '<tbody class="zbs-item-block" data-tableid="'+ zbsinvrownum +'" id="tblock'+ zbsinvrownum +'"><tr class="top-row"><td style="width:40%"><input type="text" required value="" name="zbsli_itemname'+zbsinvrownum+'" class="zbs-item-name" placeholder="Item Name"/></td><td style="width:7.5%"><input type="number" name="zbsli_quan'+ zbsinvrownum +'" class="quan" data-zbsr="'+ zbsinvrownum +'" value="0" min="0" step="0.5" placeholder="0" style="width:100%"/></td><td style="width:7.5%"><input type="number" name="zbsli_price'+zbsinvrownum+'" min="0" step="0.01" class="price" data-zbsr="'+ zbsinvrownum +'" value="0" placeholder="0" style="width:100%"/></td><td style="width:7.5%"><input type="number" name="zbsli_tax'+zbsinvrownum+'" class="tax taxhide" data-zbsr="'+ zbsinvrownum +'" value="0" min="0" max="100" placeholder="0" style="width:75%;margin-right:6px;"/>%</td><td style="width:7.5%" rowspan="2" class="row-amount row-amount-'+zbsinvrownum+'">'+ window.zbJS_curr +'0.00</td><input type="hidden" name="zbsli_rowt'+zbsinvrownum+'" class="hidden-subtotal hidden-row-amount-'+zbsinvrownum+'" value=""/><input name="zbsli_rowtt" type="hidden" class="inv-tax-subtot" id="row-tax-total-'+zbsinvrownum+'" value=""/></tr><tr class="bottom-row"><td colspan="4" class="tapad"><textarea rows="1" name="zbsli_itemdes'+zbsinvrownum+'" placeholder="Enter detailed description (optional)"></textarea></td></tr><tr class="add-row"><td colspan="2"></td><td colspan="2" class="zbs-row-actions remove-row" data-remrow ="'+ zbsinvrownum +'"><i class="fa fa-times-circle-o" aria-hidden="true"></i> Remove Row</td><td colspan="2" class="zbs-row-actions zbs-add-row"><i class="fa fa-plus-circle" aria-hidden="true"></i> Add Row</td></tr><tr class="padding"></tr></tbody>';
        }else{
		rowhtml = '<tbody class="zbs-item-block" data-tableid="'+ zbsinvrownum +'" id="tblock'+ zbsinvrownum +'"><tr class="top-row"><td style="width:40%"><input type="text" required value="" name="zbsli_itemname'+zbsinvrownum+'" class="zbs-item-name" placeholder="Item Name"/></td><td style="width:7.5%"><input type="number" name="zbsli_quan'+ zbsinvrownum +'" class="quan" data-zbsr="'+ zbsinvrownum +'" value="0" min="0" step="0.5" placeholder="0" style="width:100%"/></td><td style="width:7.5%"><input type="number" name="zbsli_price'+zbsinvrownum+'" min="0" step="0.01" class="price" data-zbsr="'+ zbsinvrownum +'" value="0" placeholder="0" style="width:100%"/></td><td style="width:7.5%" class="taxhide"><input type="number" name="zbsli_tax'+zbsinvrownum+'" class="tax taxhide" data-zbsr="'+ zbsinvrownum +'" value="0" min="0" max="100" placeholder="0" style="width:75%;margin-right:6px;"/>%</td><td style="width:7.5%" rowspan="2" class="row-amount row-amount-'+zbsinvrownum+'">'+ window.zbJS_curr +'0.00</td><input type="hidden" name="zbsli_rowt'+zbsinvrownum+'" class="hidden-subtotal hidden-row-amount-'+zbsinvrownum+'" value=""/><input name="zbsli_rowtt" type="hidden" class="inv-tax-subtot" id="row-tax-total-'+zbsinvrownum+'" value=""/></tr><tr class="bottom-row"><td colspan="3" class="tapad"><textarea rows="1" name="zbsli_itemdes'+zbsinvrownum+'" placeholder="Enter detailed description (optional)"></textarea></td></tr><tr class="add-row"><td colspan="1"></td><td colspan="2" class="zbs-row-actions remove-row" data-remrow ="'+ zbsinvrownum +'"><i class="fa fa-times-circle-o" aria-hidden="true"></i> Remove Row</td><td colspan="2" class="zbs-row-actions zbs-add-row"><i class="fa fa-plus-circle" aria-hidden="true"></i> Add Row</td></tr><tr class="padding"></tr></tbody>';
        }
        jQuery('.zbs-item-block').last().after(rowhtml);
        zbscrm_JS_bindrowactions();
        jQuery('.zbs-item-block').removeClass('selected');
        jQuery(this).parents('.zbs-item-block').addClass('selected');
	});

	jQuery('.remove-row').unbind('click').bind('click',function(e){
		var zbsremovevar = jQuery(this).data('remrow');
		if(zbsremovevar == 1){
			swal({title: "Error!",text: "You cannot remove the first row!",type: "error",confirmButtonText: "OK"});
		}else{
			jQuery('#tblock' + zbsremovevar).remove();
			extra_tax = zbscrm_JS_checkextratax();
			zbscrm_JS_calc_grandtotal(extra_tax);
		}
	});



	jQuery('.zbs-item-block').unbind('click').bind('click',function(e){
		jQuery('.zbs-item-block').removeClass('selected');
		jQuery(this).addClass('selected');
	});

	jQuery(".zbs-item-block input[type=number]").bind('keyup mouseup', function () {
		// Just reference directly: var zbsCurr = window.zbJS_curr;
		var zbs_row_to_up = jQuery(this).data('zbsr');
	    if(jQuery(this).hasClass('tax')){
	    	tax_val = jQuery(this).val()/100;  //add one for the tax
	    }
    	if(jQuery(this).hasClass('quan')){
    		quan = jQuery(this).val();
    	}
    	if(jQuery(this).hasClass('price')){
    		price = jQuery(this).val();
    	}
	    jQuery(this).parent().siblings().find('input[type=number]').each(function(index, value){
	    	if(jQuery(value).hasClass('tax')){
	    		tax_val = value.value/100;
	    	}
	    	if(jQuery(value).hasClass('quan')){
	    		quan = value.value;
	    	}
	    	if(jQuery(value).hasClass('price')){
	    		price = value.value;
	    	}
	    });
	    row_tot = quan * price;
	    if(window.zbs_tax){
	    	row_tax_tot = quan * price * tax_val;
		}else{
			row_tax_tot = row_tot;
		}
	    jQuery(this).parent().siblings('.row-amount-' + zbs_row_to_up).html(window.zbJS_curr + row_tot.toFixed(2));
	    jQuery(this).parent().siblings('.hidden-row-amount-'+ zbs_row_to_up).val(row_tot.toFixed(2));
	    jQuery('#row-tax-total-'+ zbs_row_to_up).val(row_tax_tot.toFixed(2));
          
        //calculate the sub total on a change of any input
        var zbs_sub_total = 0;
		
		jQuery('.hidden-subtotal').each(function(index,data) {
		   var value = jQuery(this).val();
		   zbs_sub_total = parseFloat(zbs_sub_total) + parseFloat(value);
		});

		jQuery('.zbs-subtotal-value').html(window.zbJS_curr + zbs_sub_total.toFixed(2));
		jQuery('#zbs-subtotal-value').val(zbs_sub_total.toFixed(2));
		extra_tax = zbscrm_JS_checkextratax();
		zbscrm_JS_calc_grandtotal(extra_tax);

	});

}


function zbscrm_JS_calculate_subrows(){
		window.zbJS_curr = window.zbJS_curr;
		jQuery('.top-row').each(function(index, pvalue){
			jQuery(pvalue).children().find('input[type=number]').each(function(index, value){
				zbs_row_to_up = jQuery(this).data('zbsr');
			    if(jQuery(this).hasClass('tax')){
			    	tax_val = jQuery(this).val()/100;  //add one for the tax
			    }
		    	if(jQuery(this).hasClass('quan')){
		    		quan = jQuery(this).val();
		    	}
		    	if(jQuery(this).hasClass('price')){
		    		price = jQuery(this).val();
		    	}
	  		});
		    row_tot = quan * price;
		    if(window.zbs_tax){
		    	row_tax_tot = quan * price * tax_val;
			}else{
				row_tax_tot = row_tot;
			}
		    jQuery('.row-amount-' + zbs_row_to_up).html(window.zbJS_curr  + row_tot.toFixed(2));
		    jQuery('.hidden-row-amount-'+ zbs_row_to_up).val(row_tot.toFixed(2));
		    jQuery('#row-tax-total-'+ zbs_row_to_up).val(row_tax_tot.toFixed(2));
        //calculate the sub total on a change of any input
	        var zbs_sub_total = 0;
			
			jQuery('.hidden-subtotal').each(function(index,data) {
			   var value = jQuery(this).val();
			   zbs_sub_total = parseFloat(zbs_sub_total) + parseFloat(value);
			});

			jQuery('.zbs-subtotal-value').html(window.zbJS_curr + zbs_sub_total.toFixed(2));
			jQuery('#zbs-subtotal-value').val(zbs_sub_total.toFixed(2));

	});
}



function zbscrm_JS_calc_onsave(){
		extra_tax = zbscrm_JS_checkextratax();
		zbscrm_JS_calc_grandtotal(extra_tax);
}

function zbscrm_JS_calc_grandtotal(extra){

		//calculate sub row totals...
		zbscrm_JS_calculate_subrows();
		zbscrm_JS_calculatediscount();
		zbscrm_JS_checkfortax(extra);
		var zbs_gt_invoice_tot = 0;

		//calculate the total...
		jQuery('.zbs_gt').each(function(index,data){
			if(jQuery(this).val() == ''){
				zbs_gt_value = 0;
			}else{
				zbs_gt_value = jQuery(this).val();
			}
			if(jQuery(data).hasClass('disc')){   //if we have a discount - deduct from the total...
				zbs_gt_invoice_tot = parseFloat(zbs_gt_invoice_tot) - parseFloat(zbs_gt_value);
			}else{
				zbs_gt_invoice_tot = parseFloat(zbs_gt_invoice_tot) + parseFloat(zbs_gt_value);
			}
		});

		jQuery('.zbs_grand_total .row-amount').html(window.zbJS_curr + zbs_gt_invoice_tot.toFixed(2));
		jQuery('#zbs-grandt-value').val(zbs_gt_invoice_tot.toFixed(2));
}

function zbscrm_JS_changeactions(){
	//the select box on invoices mainlu
	jQuery('#invoice-customiser-type').change(function() {
	  if(jQuery(this).val() == 'hours'){
	  	jQuery('#zbs_inv_qoh').html('Hours');
	  	jQuery('#zbs_inv_por').html('Rate');
	  }else{
	  	jQuery('#zbs_inv_qoh').html('Quantity');
	  	jQuery('#zbs_inv_por').html('Price');
	  }
	});

	jQuery('#invoice_postage_total').change(function(){
		jQuery('#pandptotal').html(window.zbJS_curr+parseFloat(jQuery(this).val()).toFixed(2));
			extra_tax = zbscrm_JS_checkextratax();
			zbscrm_JS_calc_grandtotal(extra_tax);
	});

	jQuery('#invoice_discount_total, #invoice_discount_type').change(function(){
		extra_tax = zbscrm_JS_checkextratax();
		zbscrm_JS_calc_grandtotal(extra_tax);
	});

	jQuery('#invoice_postage_tax').bind('keyup mouseup', function () {
		if(jQuery(this).val() != ''){
			extra_tax = zbscrm_JS_checkextratax();
			zbscrm_JS_calc_grandtotal(extra_tax);
		}
	});
}

function zbscrm_JS_checkextratax(){
			if(jQuery('#invoice_postage_total').val() != ''){
			var extra_tax = parseFloat(jQuery('#invoice_postage_tax').val())/100 * parseFloat(jQuery('#invoice_postage_total').val());
			}else{
				extra_tax = 0;
			}
			return extra_tax;
}

function zbscrm_JS_checkfortax(extra){
	
	var zbs_tax_total;
	jQuery('.zbs-item-block .tax').each(function(index,data){
		zbs_tax_total = 0;
		if(jQuery(this).val() != ''){
			zbs_tax_total = 1;
		}
	});
	var zbs_tax_post = jQuery('#invoice_postage_tax').val();
	if(zbs_tax_post > 0){
		zbs_tax_total = 1;
	}
	if(zbs_tax_total == 1){
	//then we have some tax
		if(extra == ''){
			var zbs_tax_running_total = 0;
		}else{
			var zbs_tax_running_total = extra;	
		}
		jQuery('.inv-tax-subtot').each(function(index,data){
			if(data.value != ''){
				zbs_row_taxamt = parseFloat(data.value);
				zbs_tax_running_total = parseFloat(zbs_tax_running_total) + zbs_row_taxamt;
				var zbs_discount_amt = jQuery('#invoice_discount_total').val();
				var zbs_discount_type = jQuery('#invoice_discount_type').val();
				
				if(zbs_discount_amt != ''){
					if(zbs_discount_type != 'm'){
						var zbs_tax_row_ded = zbs_row_taxamt  * zbs_discount_amt/100;
						zbs_tax_running_total = parseFloat(zbs_tax_running_total) - zbs_tax_row_ded;
					}
				}				
				jQuery('.zbs-tax-total-span').html(window.zbJS_curr + zbs_tax_running_total.toFixed(2));
				
			}
		});		

		if(zbs_tax_running_total == 0){
			jQuery('#invoice_totals .tax_total, #invoice_totals .tax_total_1').hide();
		}else{
			jQuery('#invoice_totals .tax_total, #invoice_totals .tax_total_1').show();			
		}

		jQuery('#invoice_tax_total').val(zbs_tax_running_total.toFixed(2));
	}


}

function zbscrm_JS_calculatediscount(){
		var zbs_discount_amt = jQuery('#invoice_discount_total').val();
		var zbs_discount_type = jQuery('#invoice_discount_type').val();
		if(zbs_discount_amt != ''){
			if(zbs_discount_type == 'm'){
				jQuery('#zbs_discount_combi').html('-' + window.zbJS_curr + parseFloat(zbs_discount_amt).toFixed(2));
				jQuery('#invoice_discount_total_value').val(parseFloat(zbs_discount_amt).toFixed(2));
			}else{
				var zbs_discount_combi = parseFloat(jQuery('#zbs-subtotal-value').val()) * zbs_discount_amt/100;
				jQuery('#zbs_discount_combi').html('-' + window.zbJS_curr + parseFloat(zbs_discount_combi).toFixed(2));
				jQuery('#invoice_discount_total_value').val(parseFloat(zbs_discount_combi).toFixed(2));
			}
		}
}



function zbscrm_JS_sendtestinvoice(){ 

	if (!window.zbsInvBlocker){

		// this stops multiple concurrent runs :)
		window.zbsInvBlocker = true;	    	

		var zbs_test_email = jQuery('#zbs-modal-invoice-test').val();
		if(!zbscrm_JS_validateEmail(zbs_test_email)){
			swal({title: "Error!",text: "That is not a valid email!",type: "error",confirmButtonText: "OK"});

			return false;
		}
		var invid = jQuery('#zbs_invoice_send_test2').data('zbsinvid');
		var t = {
	        action: "zbs_invoice_send_test_invoice",
	        id: invid,
	        em: zbs_test_email,
	        security: jQuery( '#inv-ajax-nonce' ).val(),
	    }
	    //console.log(t);
	    i = jQuery.ajax({
	        url: ajaxurl,
	        type: "POST",
	        data: t,
	        dataType: "json"
	    });
	    i.done(function(e) {
	    		
	    	//console.log(e);
	    	jQuery('#zbs_invoice_actions button').removeClass('disabled');
	    	jQuery('#myModal').modal('toggle');
	    	jQuery('#zbs_test_success span').html('Success: Your Test Invoice has been sent to ' + zbs_test_email);
	    	jQuery('#zbs_test_success').fadeIn(1000).delay(1000).fadeOut(1000);

	    	window.zbsInvBlocker = false;
	    	
	    }), i.fail(function(e) {
	    	//console.log(e);
	    	
	    	window.zbsInvBlocker = false;

	    });


	}
}

// all this stuff was only working because it was pasted into the end of one of my other bind functions... this stuff needs its own place!
function zbscrm_JS_mikesFloatingBinds(){

	jQuery('.zbs-add-memo-trigger').unbind('click').bind('click', function(e){
		jQuery('.zbs-memo-box').show();
		jQuery('.zbs-add-memo-trigger').hide();
	});

	jQuery('.zbs-memo-hide').unbind('click').bind('click',function(e){
		jQuery('.zbs-memo-box').hide();
		jQuery('.zbs-add-memo-trigger').show();

	});

	jQuery('.wh-logo-set .zbs-remove').unbind('click').bind('click',function(e){
		jQuery('#wh-logo-set-img').attr('src','').hide();
		jQuery('#zbs_invoice_logo').val('');
		jQuery('.wh-logo').removeClass('hide').show();
		jQuery('.wh-logo-set').hide();
	});

	jQuery('#zbs_invoice_save').unbind('click').bind('click',function(e){
		e.preventDefault();
		if(jQuery(this).hasClass('disabled')){
			return false;
		}
		extra_tax = zbscrm_JS_checkextratax();
		zbscrm_JS_calc_grandtotal(extra_tax);
		jQuery('#post').submit();
	});

	jQuery('#zbs_invoice_send').unbind('click').bind('click',function(e){
			//inv id
			if(jQuery(this).hasClass('disabled')){
				return false;
			}
			e.preventDefault();
			jQuery('#zbs_invoice_actions button').addClass('disabled');
			var invid = jQuery(this).data('zbsinvid');

			var zbs_invoice_email = jQuery('#bill').val();
			var zbs_invoice_ccemail = jQuery('#ccbill').val();


			if(zbs_invoice_email == ''){

				swal({title: "Error!",text: "You have not entered a billing email!",type: "error",confirmButtonText: "OK"});


				return false;
			}
			if(!zbscrm_JS_validateEmail(zbs_invoice_email)){
				swal({title: "Error!",text: "That is not a valid email!",type: "error",confirmButtonText: "OK"});
				return false;
			}



			if (!window.zbsInvBlocker){
				window.zbsInvBlocker = true;
					var t = {
		                action: "zbs_invoice_send_invoice",
		                id: invid,
		                em: zbs_invoice_email,
		                security: jQuery( '#inv-ajax-nonce' ).val()
		            };
		            i = jQuery.ajax({
		                url: ajaxurl,
		                type: "POST",
		                data: t,
		                dataType: "json"
		            });
		        i.done(function(e) {
		        	jQuery('#zbs_invoice_actions button').removeClass('disabled');
		        	jQuery('#zbs_success span').html('Success: Your Invoice has been sent to ' + zbs_invoice_email + ' and has been marked as unpaid');
		    		jQuery('#zbs_success').fadeIn(1000).delay(1000).fadeOut(1000);
					window.zbsInvBlocker = false;

		        }), i.fail(function() {
					window.zbsInvBlocker = false;
		        })
		    }

	});

	jQuery('.business-info-toggle').unbind('click').bind('click',function(e){
		e.preventDefault();
		if(jQuery('.business-info-toggle i').hasClass('fa-chevron-circle-right')){
			jQuery('.business-info-toggle i').removeClass('fa-chevron-circle-right').addClass('fa-chevron-circle-down');
			jQuery('.business-info').show();
		}else{
			jQuery('.business-info-toggle i').removeClass('fa-chevron-circle-down').addClass('fa-chevron-circle-right');
			jQuery('.business-info').hide();		
		}
	});

	
	jQuery('#zbs_inv_to_test').unbind('click').bind('click',function(e){
			//inv id
			if(jQuery(this).hasClass('disabled')){
				return false;
			}
			e.preventDefault();
			// should just invoke the invoice...
			//return false

			jQuery('#zbs_invoice_actions button').addClass('disabled');
			var invid = jQuery(this).data('zbsinvid');
			var t = {
                action: "zbs_invoice_send_test_invoice",
                id: invid,
                security: jQuery( '#inv-ajax-nonce' ).val()
            },
            i = jQuery.ajax({
                url: ajaxurl,
                type: "POST",
                data: t,
                dataType: "json"
            });
	        i.done(function(e) {
	        	jQuery('#zbs_invoice_actions button').removeClass('disabled');
	        }), i.fail(function() {
	        })

	});
	


	jQuery('.wh-logo, .wh-logo-set .zbs-update').unbind('click').bind('click',function(e){
		var zbs_media_frame;
			 e.preventDefault();
			// Get our Parent element
			formlabel = jQuery(this).parent();
			 // If the frame already exists, re-open it.
			 if ( zbs_media_frame ) {
			 zbs_media_frame.open();
			 return;
			 }
			 zbs_media_frame = wp.media.frames.zbs_media_frame = wp.media({
			 
			//Create our media frame
			className: 'media-frame zbs-media-frame',
			 frame: 'select', //Allow Select Only
			 multiple: false, //Disallow Mulitple selections
			 library: {
			 type: 'image' //Only allow images
			 },
			 });
			 zbs_media_frame.on('select', function(){
			 // Grab our attachment selection and construct a JSON representation of the model.
			 var media_attachment = zbs_media_frame.state().get('selection').first().toJSON();
			 
			// Send the attachment URL to our custom input field via jQuery.
			 
			 jQuery('#logo').val(media_attachment.url);
			 jQuery('#wh-logo-set-img').attr('src', media_attachment.url).show();
			 jQuery('.wh-logo-set').show();
			 jQuery('.wh-logo').hide();

			 });
			 
			// Now that everything has been set, let's open up the frame.
			 zbs_media_frame.open();
	});


}